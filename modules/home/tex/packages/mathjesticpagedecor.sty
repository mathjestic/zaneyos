\ProvidesPackage{mathjesticpagedecor}

\RequirePackage{expl3}
\RequirePackage{tikz}
\RequirePackage{graphicx}
\RequirePackage{xcolor}
\RequirePackage{fancyhdr}
\RequirePackage{fontawesome5}
\RequirePackage{relsize}

\ExplSyntaxOn

% -- Page Decoration Colors --
\newlength{\foottikzheight}
\setlength{\foottikzheight}{0.5cm}

\NewDocumentCommand { \mathjesticwebsite } {  } {
  \href{https://mathjestic.id/}{mathjestic.id}%
}

\NewDocumentCommand { \mathjesticinstagram } {  } {
  \href{https://www.instagram.com/mathjestic.id/}{\relsize{-1}\faInstagram}%
}

\NewDocumentCommand { \mathjesticwhatsapp } {  } {
  \href{https://wa.me/6282337293909}{\relsize{-1}\faWhatsapp}%
}

\NewDocumentCommand { \mathjestictiktok } {  } {
  \href{https://www.tiktok.com/@mathjestic}{\relsize{-1}\faTiktok}%
}

\NewDocumentCommand { \mathjesticyoutube } {  } {
  \href{https://www.youtube.com/@mathjestic}{\relsize{-1}\faYoutube}%
}

\tl_new:N \g_mj_materiapa_tl
\tl_new:N \g_mj_kontaksiapa_tl
\tl_new:N \g_mj_levelberapa_tl
\tl_new:N \g_mj_levelband_tl

% \tl_gset:Nn \g_mj_kontaksiapa_tl {}
\tl_gset:Nn \g_mj_levelberapa_tl {1}

\NewDocumentCommand \materiapa { m } { \tl_gset:Nn \g_mj_materiapa_tl {#1} }
\NewDocumentCommand \kontaksiapa { m } { \tl_gset:Nn \g_mj_kontaksiapa_tl {#1} }
\NewDocumentCommand \levelberapa { m } { \tl_gset:Nn \g_mj_levelberapa_tl {#1} }

\NewDocumentCommand { \personalinstagram } {  } {
  \IfVideoTF {
    \tl_use:N \g_mj_kontaksiapa_tl
  } {
    \href{https://www.instagram.com/nabilnnw/}{Nabil~Nabawi~Wibisono,~S.Si.}%
  }
}

\cs_new_protected:Npn \mj_update_levelband:
  {
    % Read the current level as an integer once
    \int_set:Nn \l_tmpa_int { \tl_use:N \g_mj_levelberapa_tl }
    % Map to band
    \int_compare:nTF { \l_tmpa_int <= 2 }
      { \tl_gset:Nn \g_mj_levelband_tl { Knowing } }
      {
        \int_compare:nTF { \l_tmpa_int <= 4 }
          { \tl_gset:Nn \g_mj_levelband_tl { Applying } }
          { \tl_gset:Nn \g_mj_levelband_tl { Reasoning } }
      }
  }

% -- TikZ Header --
\newcommand*\tikzhead{%
  \exp_args:NV \setcolortheme \g_color_palette_str
  \begin{tikzpicture}[remember~picture, overlay]
    \tikzmath{
      \xshiftfirst = 0.015625\paperwidth; 
      \xshiftsecond = 0.03125\paperwidth; 
      \xshiftthird = 0.0625\paperwidth; 
      \xshiftfourth = 0.125\paperwidth; 
      \xshiftfifth = 0.25\paperwidth;
    }
    \node [anchor = north~west, inner~sep=0, outer~sep=0] at (current~page.north~west) {\includegraphics[scale=1, trim=0~0~0~0, clip]{header-\mycolortheme}};

    \IfVideoTF {
      \node [text=\g_color_csix_on_cone_str, font=\footnotesize\sffamily, xshift=-0.015625\paperwidth + 1.55mm, yshift=-0.5\foottikzheight, anchor=east, inner~sep=0, outer~sep=0] at (current~page.north~east) {\tl_use:N \g_mj_materiapa_tl};
      %\mj_update_levelband:
      %\node [text=\g_color_csix_on_cone_str, font=\footnotesize\sffamily, xshift=-0.5\paperwidth + \xshiftfirst - 1.55mm, yshift=-0.5\foottikzheight, anchor=west, inner~sep=0, outer~sep=0] at (current~page.north~east) {Level~\tl_use:N \g_mj_levelberapa_tl \hspace{1mm}[\hspace{1mm} \tl_use:N \g_mj_levelband_tl \hspace{1mm}]};
    } {
      \node [text=\g_color_csix_on_cone_str, font=\footnotesize\sffamily, xshift=-0.015625\paperwidth + 1.55mm, yshift=-0.5\foottikzheight, anchor=east, inner~sep=0, outer~sep=0] at (current~page.north~east) {\rightmark};
    }

    \mathjestic_headericon_if_in:nT {ig} { \node [text=\g_icon_color_correction_one_str, font=\footnotesize\sffamily, xshift=\xshiftfirst, yshift=-0.5\foottikzheight, anchor=center, inner~sep=0, outer~sep=0] at (current~page.north~west) {\mathjesticinstagram}; }

    \mathjestic_headericon_if_in:nT {wa} { \node [text=\g_icon_color_correction_two_str, font=\footnotesize\sffamily, xshift=\xshiftfirst + \xshiftsecond, yshift=-0.5\foottikzheight, anchor=center, inner~sep=0, outer~sep=0] at (current~page.north~west) {\mathjesticwhatsapp}; }

    \mathjestic_headericon_if_in:nT {tt} { \node [text=\g_icon_color_correction_three_str, font=\footnotesize\sffamily, xshift=\xshiftfirst + \xshiftthird, yshift=-0.5\foottikzheight, anchor=center, inner~sep=0, outer~sep=0] at (current~page.north~west) {\mathjestictiktok}; }

    \mathjestic_headericon_if_in:nT {yt} { \node [text=\g_icon_color_correction_four_str, font=\footnotesize\sffamily, xshift=\xshiftfirst + \xshiftsecond + \xshiftthird, yshift=-0.5\foottikzheight, anchor=center, inner~sep=0, outer~sep=0] at (current~page.north~west) {\mathjesticyoutube}; }

    \mathjestic_headericon_if_in:nT {web} { \node [text=\g_icon_color_correction_five_str, font=\footnotesize\sffamily, xshift=-\xshiftfifth - \xshiftthird, yshift=-0.5\foottikzheight, anchor=center, inner~sep=0, outer~sep=0] at (current~page.north) {\mathjesticwebsite}; }
  \end{tikzpicture}
}

% -- TikZ Footer --
\newcommand*\tikzfoot{%
  \exp_args:NV \setcolortheme \g_color_palette_str
  \begin{tikzpicture}[remember~picture, overlay]
    \node [anchor = south~west, inner~sep=0, outer~sep=0] at (current~page.south~west) {\includegraphics[scale=1, trim=0~0~0~0, clip]{footer-\mycolortheme}};
    \node [text=\g_color_cone_on_csix_str, font=\footnotesize\sffamily, xshift=-0.015625\paperwidth, yshift=0.5\foottikzheight, inner~sep=0, outer~sep=0] at (current~page.south~east) {\thepage};
    \node [text=\g_color_csix_on_cone_str, font=\footnotesize\sffamily, xshift=0.015625\paperwidth-1.55mm, yshift=0.5\foottikzheight, anchor=west, inner~sep=0, outer~sep=0] at (current~page.south~west) {\personalinstagram};
  \end{tikzpicture}
}
\ExplSyntaxOff

% -- Set fancyhdr with these decorations --
\IfVideoTF{
  \setlength{\headheight}{20pt} % Avoid header warning
  \setlength{\footskip}{20pt} % Avoid footer warning
} {
  \setlength{\headheight}{15pt} % Avoid header warning
}
\fancyhf{} % Clear all header/footer fields
\renewcommand{\headrulewidth}{0pt} % Remove header line
\fancyhead{\tikzhead}
\fancyfoot{\tikzfoot}
\pagestyle{fancy}

% -- Section for right/left marks in header --
\renewcommand{\sectionmark}[1]{\markright{\thesection \ #1}}
\renewcommand{\subsectionmark}[1]{\markright{\thesubsection \ #1}}

% -- Title page decoration --
\newcommand*\titlepagedecoration{%
  \begin{tikzpicture}[remember picture, overlay]
    \IfVideoTF {
      \node [anchor = north west, inner sep=0, outer sep=0] at (current page.north west) {\includegraphics[scale=1, trim=0 0 0 0, clip]{titlepage-video-\mycolortheme}};
    } {
      \node [anchor = north west, inner sep=0, outer sep=0] at (current page.north west) {\includegraphics[scale=1, trim=0 0 0 0, clip]{titlepage-\mycolortheme}};
    }
  \end{tikzpicture}
}

\newcommand*\putlogomid{%
  \begin{tikzpicture}[remember picture, overlay]
    \node [anchor = center, inner sep=0, outer sep=0] at (current page.center) {%
      \includegraphics[scale=0.75, trim=0 0 0 0, clip]{mathjestic-\mycolortheme}%
    };
  \end{tikzpicture}
}

\ExplSyntaxOn

\newcommand{\makesectionpage}{%
  \thispagestyle{empty}
  \titlepagedecoration
  \begin{center}
    \fontsize{35}{42}\selectfont\bfseries\sffamily\textcolor{c1}{\l_current_problemset_handle_str}
  \end{center}
  \putlogomid
}

\newcommand{\makethetitle}{%
  \begin{titlingpage}
    \maketitle
  \end{titlingpage}%
}

\newcommand{\subtitle}[1]{%
  \posttitle{%
  \par\end{center}\vskip3em
  \begin{center}\textcolor{c2}{\fontsize{20}{24}\selectfont\bfseries\sffamily#1}\end{center}
\vskip2em}%
}

\tl_new:N \g_mj_title_tl
\tl_new:N \g_mj_subtitle_tl
\tl_new:N \g_mj_author_tl
\tl_new:N \g_mj_date_tl
\tl_new:N \g_mj_webname_tl
\tl_gset:Nn \g_mj_webname_tl {@mathjestic.id}

% Setters (global) — leave unset to suppress printing
\NewDocumentCommand \mytitle    { m } { \tl_gset:Nn \g_mj_title_tl    {#1} }
\NewDocumentCommand \mysubtitle { m } { \tl_gset:Nn \g_mj_subtitle_tl {#1} }
\NewDocumentCommand \myauthor   { m } { \tl_gset:Nn \g_mj_author_tl   {#1} \author{#1} }
\NewDocumentCommand \mydate     { m } { \tl_gset:Nn \g_mj_date_tl     {#1} }

\NewDocumentCommand \mymaketitle { } {%
  \thispagestyle{empty}%
  \titlepagedecoration
  \putlogomid
  \NoWatermarkThisPage
  \par\IfVideoTF{\vspace*{-2em}}{\vspace*{0em}}%
  \begin{center}%
    % Title (print only if nonblank)
    \tl_if_blank:VTF \g_mj_title_tl
      { } % blank → nothing
      { {\color{c1}\fontsize{35}{42}\selectfont\bfseries\sffamily \tl_use:N \g_mj_title_tl \par} }

    % Subtitle (print only if nonblank)
    \tl_if_blank:VTF \g_mj_subtitle_tl
      { } % blank → nothing
      { \vskip 1em {\color{c2}\fontsize{20}{24}\selectfont\bfseries\sffamily \tl_use:N \g_mj_subtitle_tl \par} }

    \vfill % keep your layout

    % Author (print only if nonblank)
    \tl_if_blank:VTF \g_mj_author_tl
      { } % blank → nothing
      { \IfVideoTF {
          \color{\g_cthree_color_correction_str}\Large\sffamily \tl_use:N \g_mj_webname_tl \rmfamily
        } {
          \color{\g_cthree_color_correction_str}\Large\scshape \tl_use:N \g_mj_author_tl
        } \par
      }

    % Date (print only if nonblank)
    \tl_if_blank:VTF \g_mj_date_tl
      { } % blank → nothing
      { \vskip 0em \IfVideoTF {
          \normalsize\scshape\color{\g_cthree_color_correction_str} Posted~On:~ \tl_use:N \g_mj_date_tl
        } {\normalsize\scshape\color{\g_cthree_color_correction_str} Updated~ On:~ \tl_use:N \g_mj_date_tl } \par
      }
  \end{center}%
  \par\vspace{1.5em}%
  \newpage
}
\ExplSyntaxOff
